#!/bin/sh
# Jonas Genannt <jonas.genannt@capi2name.de>, 2012 for the Debian Project
# Modified by Ken Robertson, Apcera Inc.
#
# This file is generated by Chef. Do not modify it directly.

set -e

INDEX_FILE_TMP=$(mktemp)

INDEX_FILE="<%= node[:graphite][:storage_dir] %>/index"
WHISPER_DIR="<%= node[:graphite][:storage_dir] %>/whisper"

cd ${WHISPER_DIR} && find -L . -name '*.wsp' | sed \
	-e 's@\.wsp$@@' \
	-e 's@^\./@@' \
	-e 's@/@.@g' > ${INDEX_FILE_TMP}

chmod 0640 ${INDEX_FILE_TMP}

mv -f ${INDEX_FILE_TMP} ${INDEX_FILE}
chown <%= node[:graphite][:user_account] %>:<%= node[:graphite][:group_account] %> ${INDEX_FILE}
