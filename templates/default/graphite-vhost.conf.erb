# Graphite Apache Virtual Host
#
# Generated by Chef
<% if node['graphite']['listen_port'] != "80" %>
Listen <%= node['graphite']['listen_port'] %>
<% end %>
NameVirtualHost *:<%= node['graphite']['listen_port'] %>

# You may need to manually edit this file to fit your needs.
<VirtualHost *:<%= node['graphite']['listen_port']%>>
  ServerName <%= node['graphite']['url'] %>
  <% unless node['graphite']['url_aliases'].empty? %>
  ServerAlias <%= [node['graphite']['url_aliases']].flatten.compact.join(" ") %>
  <% end %>
  DocumentRoot "<%= node['graphite']['doc_root'] %>"
  ErrorLog <%= node['graphite']['log_dir'] %>/webapp/error.log
  CustomLog <%= node['graphite']['log_dir'] %>/webapp/access.log common

  <Location "/">
    SetHandler python-program
    PythonPath "['<%= node['graphite']['doc_root'] %>'] + sys.path"
    PythonHandler django.core.handlers.modpython
    SetEnv DJANGO_SETTINGS_MODULE graphite.settings
    PythonDebug Off
    PythonAutoReload Off

<% if node['graphite']['basic_authentication']['enabled'] == true -%>
    AuthType basic
    AuthName "<%= node['graphite']['basic_authentication']['auth_name'] %>"
    AuthUserFile <%= node['graphite']['basic_authentication']['htpasswd_location'] %>
    require valid-user
<% end -%>
  </Location>

  <Location "/content/">
    SetHandler None
  </Location>

  <Location "/media/">
    SetHandler None
  </Location>

  <% if node['recipes'].include? "ganglia::web" -%>
  <Location "/ganglia/">
    SetHandler None
  </Location>
  <% end -%>

  # NOTE: In order for the django admin site media to work you
  # must change @DJANGO_ROOT@ to be the path to your django
  # installation, which is probably something like:
  # /usr/lib/python2.6/site-packages/django
  Alias /media/ "@DJANGO_ROOT@/contrib/admin/media/"
</VirtualHost>
